<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lynkr Web - Bookmark Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #212121;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: #212121;
            border-bottom: 1px solid #3a3a3d;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo {
            color: #5a8daa;
            font-size: 24px;
        }

        .app-title {
            font-weight: bold;
            font-size: 18px;
        }

        .header-buttons button {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
        }

        .header-buttons button:hover {
            background: #404040;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 220px;
            background: #1a1a1a;
            border-right: 1px solid #3a3a3d;
            display: flex;
            flex-direction: column;
        }

        .tabs-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .tab-button {
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            margin-bottom: 4px;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: #aaa;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab-button:hover {
            background: #2a2a2a;
        }

        .tab-button.active {
            background: #2a4d6a;
            color: white;
        }

        .sidebar-footer {
            padding: 12px;
        }

        .import-export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: #353535;
        }

        .btn-primary {
            background: #2a4d6a;
            color: white;
        }

        .btn-primary:hover {
            background: #3a6d8a;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .add-bookmark-bar {
            background: #1a1a1a;
            border-bottom: 1px solid #3a3a3d;
            padding: 16px;
        }

        .add-bookmark-form {
            display: flex;
            gap: 12px;
        }

        .url-input {
            flex: 1;
            padding: 10px 12px;
            background: #2a2a2a;
            border: 1px solid #3a3a3d;
            border-radius: 4px;
            color: white;
            font-size: 13px;
        }

        .url-input:focus {
            outline: none;
            border-color: #5a8daa;
            background: #353535;
        }

        .bookmarks-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .group-card {
            margin-bottom: 16px;
            border-radius: 4px;
            overflow: hidden;
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
        }

        .group-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .group-title {
            font-weight: 600;
            font-size: 16px;
            color: white;
        }

        .group-count {
            color: #ccc;
            font-size: 14px;
        }

        .group-content {
            padding: 20px;
        }

        .bookmark-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bookmark-card:hover {
            filter: brightness(1.15);
        }

        .bookmark-icon {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            object-fit: cover;
        }

        .bookmark-info {
            flex: 1;
            min-width: 0;
        }

        .bookmark-title {
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bookmark-url {
            font-size: 12px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #3a3a3d;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 1000;
            min-width: 180px;
            padding: 4px 0;
        }

        .context-menu-item {
            width: 100%;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background: #3a3a3a;
        }

        .context-menu-item.danger {
            color: #e81123;
        }

        .context-menu-item.danger:hover {
            background: rgba(232, 17, 35, 0.2);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .modal {
            background: #2a2a2a;
            border: 1px solid #3a3a3d;
            border-radius: 8px;
            padding: 24px;
            width: 400px;
            max-width: 90%;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-input {
            width: 100%;
            padding: 10px 12px;
            background: #1a1a1a;
            border: 1px solid #3a3a3d;
            border-radius: 4px;
            color: white;
            font-size: 13px;
            margin-bottom: 16px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #5a8daa;
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .status-bar {
            background: #1a1a1a;
            border-top: 1px solid #3a3a3d;
            padding: 4px 16px;
            font-size: 11px;
            color: #666;
            text-align: right;
        }

        .chevron {
            transition: transform 0.2s;
        }

        .chevron.collapsed {
            transform: rotate(-90deg);
        }

        .hidden {
            display: none;
        }

        .more-button {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 18px;
        }

        .more-button:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo">üîó</div>
                <div class="app-title">Lynkr Web</div>
            </div>
            <div class="header-buttons">
                <button onclick="toggleMaximize()" title="Maximize">‚õ∂</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="tabs-list" id="tabsList"></div>
                <div class="sidebar-footer">
                    <div class="import-export-buttons">
                        <button class="btn btn-secondary" onclick="importTab()">üì• Import</button>
                        <button class="btn btn-secondary" onclick="exportCurrentTab()">üì§ Export</button>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="showAddTabDialog()">+ New Tab</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Add Bookmark Bar -->
                <div class="add-bookmark-bar">
                    <div class="add-bookmark-form">
                        <input 
                            type="text" 
                            id="urlInput" 
                            class="url-input" 
                            placeholder="Enter URL..."
                            onkeypress="handleUrlKeyPress(event)"
                        >
                        <button class="btn btn-primary" onclick="addBookmark()">Add Bookmark</button>
                    </div>
                </div>

                <!-- Bookmarks Area -->
                <div class="bookmarks-area" id="bookmarksArea" oncontextmenu="showBackgroundContextMenu(event)"></div>

                <!-- Status Bar -->
                <div class="status-bar">Lynkr Web v1.0.0</div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".lynk,.json" onchange="handleFileImport(event)">

    <script>
        // State
        let appState = {
            tabs: [],
            currentTab: null,
            backgroundColor: '#212121'
        };

        // Initialize
        function init() {
            loadFromStorage();
            if (appState.tabs.length === 0) {
                createTab('Default');
            }
            renderTabs();
            renderBookmarks();
        }

        // Storage
        function saveToStorage() {
            const data = {
                backgroundColor: appState.backgroundColor,
                currentTab: appState.currentTab?.name,
                tabs: appState.tabs.map(tab => ({
                    name: tab.name,
                    tabColor: tab.tabColor || '#2A4D6A',
                    groups: Object.entries(tab.groups || {}).map(([name, group]) => ({
                        name,
                        headerColor: group.headerColor || '#2A2A2A',
                        backgroundColor: group.backgroundColor || '#1A1A1A',
                        isCollapsed: group.isCollapsed || false,
                        order: group.order || 0,
                        bookmarks: (group.bookmarks || []).map(b => ({
                            title: b.title,
                            url: b.url,
                            thumbnailUrl: b.thumbnailUrl,
                            dateAdded: b.dateAdded,
                            backgroundColor: b.backgroundColor || '#252525'
                        }))
                    }))
                }))
            };
            localStorage.setItem('lynkr-data', JSON.stringify(data));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('lynkr-data');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.backgroundColor) appState.backgroundColor = data.backgroundColor;
                    
                    if (data.tabs && data.tabs.length > 0) {
                        appState.tabs = data.tabs.map(tabData => ({
                            name: tabData.name,
                            tabColor: tabData.tabColor || '#2A4D6A',
                            groups: (tabData.groups || []).reduce((acc, group) => {
                                acc[group.name] = {
                                    headerColor: group.headerColor || '#2A2A2A',
                                    backgroundColor: group.backgroundColor || '#1A1A1A',
                                    isCollapsed: group.isCollapsed || false,
                                    order: group.order || 0,
                                    bookmarks: group.bookmarks || []
                                };
                                return acc;
                            }, {})
                        }));
                        
                        appState.currentTab = appState.tabs.find(t => t.name === data.currentTab) || appState.tabs[0];
                    }
                } catch (e) {
                    console.error('Failed to load data:', e);
                }
            }
        }

        // Tabs
        function createTab(name) {
            if (!name || appState.tabs.some(t => t.name === name)) return;
            
            const tab = {
                name,
                tabColor: '#2A4D6A',
                groups: {}
            };
            
            appState.tabs.push(tab);
            appState.currentTab = tab;
            saveToStorage();
            renderTabs();
            renderBookmarks();
        }

        function switchTab(tab) {
            appState.currentTab = tab;
            saveToStorage();
            renderTabs();
            renderBookmarks();
        }

        function deleteTab(tab) {
            if (!confirm(`Delete tab "${tab.name}"?`)) return;
            
            appState.tabs = appState.tabs.filter(t => t.name !== tab.name);
            
            if (appState.currentTab.name === tab.name) {
                appState.currentTab = appState.tabs[0] || null;
            }
            
            saveToStorage();
            renderTabs();
            renderBookmarks();
        }

        function renderTabs() {
            const container = document.getElementById('tabsList');
            container.innerHTML = appState.tabs.map(tab => `
                <button 
                    class="tab-button ${appState.currentTab?.name === tab.name ? 'active' : ''}"
                    style="${appState.currentTab?.name === tab.name ? `background-color: ${tab.tabColor}; color: white;` : ''}"
                    onclick="switchTab(${JSON.stringify(tab).replace(/"/g, '&quot;')})"
                    oncontextmenu="showTabContextMenu(event, ${JSON.stringify(tab).replace(/"/g, '&quot;')})"
                >
                    ${tab.name}
                </button>
            `).join('');
        }

        // Groups
        function createGroup(name) {
            if (!name || !appState.currentTab) return;
            
            appState.currentTab.groups[name] = {
                bookmarks: [],
                isCollapsed: false,
                order: Object.keys(appState.currentTab.groups).length,
                headerColor: '#2A2A2A',
                backgroundColor: '#1A1A1A'
            };
            
            saveToStorage();
            renderBookmarks();
        }

        function deleteGroup(groupName) {
            if (!confirm(`Delete group "${groupName}" and all its bookmarks?`)) return;
            
            delete appState.currentTab.groups[groupName];
            saveToStorage();
            renderBookmarks();
        }

        function toggleGroupCollapse(groupName) {
            const group = appState.currentTab.groups[groupName];
            group.isCollapsed = !group.isCollapsed;
            saveToStorage();
            renderBookmarks();
        }

        // Bookmarks
        function getFaviconUrl(url) {
            try {
                const domain = new URL(url).hostname;
                return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
            } catch {
                return 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"%3E%3Cpath d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/%3E%3C/svg%3E';
            }
        }

        function getPageTitle(url) {
            try {
                const domain = new URL(url).hostname.replace('www.', '');
                return domain.charAt(0).toUpperCase() + domain.slice(1);
            } catch {
                return 'Bookmark';
            }
        }

        function addBookmark() {
            const input = document.getElementById('urlInput');
            let url = input.value.trim();
            
            if (!url || !appState.currentTab) return;
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }

            const title = getPageTitle(url);
            const thumbnailUrl = getFaviconUrl(url);
            
            const groupName = Object.keys(appState.currentTab.groups)[0] || 'Bookmarks';
            
            if (!appState.currentTab.groups[groupName]) {
                appState.currentTab.groups[groupName] = {
                    bookmarks: [],
                    isCollapsed: false,
                    order: 0,
                    headerColor: '#2A2A2A',
                    backgroundColor: '#1A1A1A'
                };
            }
            
            appState.currentTab.groups[groupName].bookmarks.push({
                title,
                url,
                thumbnailUrl,
                dateAdded: new Date().toISOString(),
                backgroundColor: '#252525'
            });
            
            input.value = '';
            saveToStorage();
            renderBookmarks();
        }

        function deleteBookmark(groupName, bookmarkIndex) {
            appState.currentTab.groups[groupName].bookmarks.splice(bookmarkIndex, 1);
            saveToStorage();
            renderBookmarks();
        }

        function handleUrlKeyPress(event) {
            if (event.key === 'Enter') {
                addBookmark();
            }
        }

        function renderBookmarks() {
            const container = document.getElementById('bookmarksArea');
            container.style.backgroundColor = appState.backgroundColor;
            
            if (!appState.currentTab) {
                container.innerHTML = '';
                return;
            }

            const groups = Object.entries(appState.currentTab.groups)
                .sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

            container.innerHTML = groups.map(([groupName, group]) => `
                <div class="group-card">
                    <div class="group-header" style="background-color: ${group.headerColor}; border-bottom: 1px solid #3a3a3d;">
                        <div class="group-header-left" onclick="toggleGroupCollapse('${groupName}')">
                            <span class="chevron ${group.isCollapsed ? 'collapsed' : ''}">‚ñº</span>
                            <span class="group-title">${groupName}</span>
                            <span class="group-count">(${group.bookmarks?.length || 0})</span>
                        </div>
                        <button class="more-button" onclick="showGroupContextMenu(event, '${groupName}')">‚ãÆ</button>
                    </div>
                    <div class="group-content ${group.isCollapsed ? 'hidden' : ''}" style="background-color: ${group.backgroundColor};">
                        ${(group.bookmarks || []).map((bookmark, idx) => `
                            <div 
                                class="bookmark-card" 
                                style="background-color: ${bookmark.backgroundColor};"
                                ondblclick="window.open('${bookmark.url}', '_blank')"
                                oncontextmenu="showBookmarkContextMenu(event, '${groupName}', ${idx})"
                            >
                                <img src="${bookmark.thumbnailUrl}" class="bookmark-icon" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22white%22 stroke-width=%222%22%3E%3Cpath d=%22M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71%22/%3E%3C/svg%3E'">
                                <div class="bookmark-info">
                                    <div class="bookmark-title">${bookmark.title}</div>
                                    <div class="bookmark-url">${bookmark.url}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Import/Export
        function exportCurrentTab() {
            if (!appState.currentTab) return;
            
            const data = {
                name: appState.currentTab.name,
                tabColor: appState.currentTab.tabColor,
                groups: Object.entries(appState.currentTab.groups).map(([name, group]) => ({
                    name,
                    headerColor: group.headerColor,
                    backgroundColor: group.backgroundColor,
                    isCollapsed: group.isCollapsed,
                    order: group.order,
                    bookmarks: group.bookmarks
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${appState.currentTab.name}.lynk`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importTab() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    console.log('Imported data:', data); // Debug log
                    
                    // Handle both tab export format and potential other formats
                    let tabName = data.Name || data.name || 'Imported Tab';
                    let tabColor = data.TabColor || data.tabColor || '#2A4D6A';
                    let groupsData = data.Groups || data.groups || [];
                    
                    let counter = 1;
                    const originalName = tabName;
                    while (appState.tabs.some(t => t.name === tabName)) {
                        counter++;
                        tabName = `${originalName} (${counter})`;
                    }
                    
                    const newTab = {
                        name: tabName,
                        tabColor: tabColor,
                        groups: {}
                    };
                    
                    // Process groups
                    if (Array.isArray(groupsData)) {
                        groupsData.forEach((group, index) => {
                            const groupName = group.Name || group.name || `Group ${index + 1}`;
                            newTab.groups[groupName] = {
                                headerColor: group.HeaderColor || group.headerColor || '#2A2A2A',
                                backgroundColor: group.BackgroundColor || group.backgroundColor || '#1A1A1A',
                                isCollapsed: group.IsCollapsed || group.isCollapsed || false,
                                order: group.Order !== undefined ? group.Order : (group.order !== undefined ? group.order : index),
                                bookmarks: []
                            };
                            
                            // Process bookmarks
                            const bookmarksData = group.Bookmarks || group.bookmarks || [];
                            if (Array.isArray(bookmarksData)) {
                                bookmarksData.forEach(bookmark => {
                                    newTab.groups[groupName].bookmarks.push({
                                        title: bookmark.Title || bookmark.title || 'Untitled',
                                        url: bookmark.Url || bookmark.url || '',
                                        thumbnailUrl: bookmark.ThumbnailUrl || bookmark.thumbnailUrl || '',
                                        dateAdded: bookmark.DateAdded || bookmark.dateAdded || new Date().toISOString(),
                                        backgroundColor: bookmark.BackgroundColor || bookmark.backgroundColor || '#252525'
                                    });
                                });
                            }
                        });
                    }
                    
                    appState.tabs.push(newTab);
                    appState.currentTab = newTab;
                    saveToStorage();
                    renderTabs();
                    renderBookmarks();
                    
                    const totalBookmarks = Object.values(newTab.groups).reduce((sum, g) => sum + g.bookmarks.length, 0);
                    alert(`Imported ${Object.keys(newTab.groups).length} groups with ${totalBookmarks} bookmarks!`);
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing file: ' + error.message + '\n\nCheck console for details.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Context Menus
        let activeContextMenu = null;

        function closeContextMenu() {
            if (activeContextMenu) {
                activeContextMenu.remove();
                activeContextMenu = null;
            }
        }

        function showContextMenu(x, y, items) {
            closeContextMenu();
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.innerHTML = items.map(item => `
                <button class="context-menu-item ${item.danger ? 'danger' : ''}" onclick="${item.action}">
                    ${item.icon} ${item.label}
                </button>
            `).join('');
            
            document.body.appendChild(menu);
            activeContextMenu = menu;
            
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu, { once: true });
            }, 0);
        }

        function showGroupContextMenu(event, groupName) {
            event.preventDefault();
            event.stopPropagation();
            
            showContextMenu(event.clientX, event.clientY, [
                { icon: '‚ûï', label: 'Add Bookmark', action: `showAddBookmarkDialog('${groupName}'); closeContextMenu();` },
                { icon: 'üóëÔ∏è', label: 'Delete Group', action: `deleteGroup('${groupName}'); closeContextMenu();`, danger: true }
            ]);
        }

        function showBookmarkContextMenu(event, groupName, bookmarkIndex) {
            event.preventDefault();
            event.stopPropagation();
            
            showContextMenu(event.clientX, event.clientY, [
                { icon: 'üóëÔ∏è', label: 'Delete Bookmark', action: `deleteBookmark('${groupName}', ${bookmarkIndex}); closeContextMenu();`, danger: true }
            ]);
        }

        function showBackgroundContextMenu(event) {
            event.preventDefault();
            
            showContextMenu(event.clientX, event.clientY, [
                { icon: 'üìÅ', label: 'Add New Group', action: 'showAddGroupDialog(); closeContextMenu();' }
            ]);
        }

        function showTabContextMenu(event, tab) {
            event.preventDefault();
            event.stopPropagation();
            
            const tabJson = JSON.stringify(tab).replace(/"/g, '&quot;');
            
            showContextMenu(event.clientX, event.clientY, [
                { icon: 'üì§', label: 'Export Tab', action: `exportCurrentTab(); closeContextMenu();` },
                { icon: 'üóëÔ∏è', label: 'Delete Tab', action: `deleteTab(${tabJson}); closeContextMenu();`, danger: true }
            ]);
        }

        // Dialogs
        function showAddGroupDialog() {
            const name = prompt('Group name:');
            if (name) createGroup(name);
        }

        function showAddTabDialog() {
            const name = prompt('Tab name:');
            if (name) createTab(name);
        }

        function showAddBookmarkDialog(groupName) {
            const url = prompt('Bookmark URL:');
            if (!url) return;
            
            document.getElementById('urlInput').value = url;
            addBookmark();
        }

        // Utilities
        function toggleMaximize() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Initialize app
        init();
    </script>
</body>
</html>
